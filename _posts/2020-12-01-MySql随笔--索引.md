---
title: MySql随笔--索引
key: 20201201
tags: 数据库 MySql
---

# 索引
聚集索引(clustered index) : id为PK，聚集索引，叶子节点存储行记录；

辅助索引(secondary index) : name为KEY，普通索引，叶子节点存储PK值，即id

回表：通过辅助索引查询数据，需要扫描两遍索引树：
* 先通过普通索引定位到主键值id=5
* 在通过聚集索引定位到行记录

## B+树索引

可用查询类型,假设存在索引 (a,b,c),最左前缀匹配原则,想要所有列都使用索引，筛选条件必须按照索引字段从左到右的顺序匹配，并且向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，比如
* 全值匹配 select * from table where **a=xxx and b=xxx and c=xxx**
* 匹配最左前辍 select * from table where **a=xxx** 或者select * from table where **a=xxx b=xxx**
* 匹配范围值为最右列 select * from table where **a>xxx** 或者 select * from table where **a>xxx and b>xxx**

比如以下情况无法使用索引（或者部分条件无法使用索引）：
* 非匹配最左前辍 select * from table where **b=xxx**
* 部分列最左前辍 select * from table where **a=xxx and c=xxx**  只能使用索引的a列
* 中间存在范围匹配 select * from table where **a=xxx and b>xxx and c=xxx** 只能使用索引的a,b列

这些原则的本质原因在于索引 (a,b,c)在索引树的最底层上是按照a,b,c的顺序进行排序的。索引顺序必须和查找的顺序一致

## 三星索引（如何评价一个索引）：
* 将相关记录放置到一起（获得一星）
* 索引中数据的顺序与查找的顺序一致（获得两星）
* 索引的列包含了查询中需要的全部列，即索引覆盖 （获得三星）

## 前辍索引
字符串太大，只索引其前辍以节省索引空间。一般前辍越长选择性越高，但索引空间消耗越多。
缺点在于无法使用前辍索引进行order by 和 group by，也无法进行索引覆盖

## 联合索引的顺序
具体情况具体分析，一般按照where条件中选择性高的放在前面

## 索引合并
todo

## 聚集索引
InnoDB引擎通过主键聚集数据。聚集索引的叶子页存放着数据行，数据行在物理上是按照聚集索引键的顺序进行存储的

优点：
* 相同（或相邻）主键的数据存放一起。一次磁盘IO就可读取。具有空间局部性
* 数据访问快。聚集索引的叶子页就存放着数据行

缺点：
* 插入数据依赖插入顺序，按照主键的顺序的插入是最快的方式，非主键顺序插入空间局部性低，不利于缓冲池的工作
* 更新聚集索引代价高，因为要移动之前插入的数据行
* 非主键顺序插入，更慢，以及更大的索引空间,因为**页分裂和碎片**

## 页分裂与合并
https://zhuanlan.zhihu.com/p/98818611

页分裂会导致聚集索引存储在物理上的不连续

## 索引覆盖
索引列包含了查询的所有列，使得所有信息可以从索引中获取，不需要回表查询
比如存在联合索引(a,b,c)

select a,b,c from table where a=xxx and b=xxx


# Explain

## Extra
Using index 
* 查询的列被索引覆盖，并且where筛选条件是索引的是前导列，Extra中为Using index

Using where Using index
* 查询的列被索引覆盖，并且where筛选条件是索引列之一但是不是索引的不是前导列，Extra中为Using where; Using index，意味着无法直接通过索引查找来查询到符合条件的数据
* 查询的列被索引覆盖，并且where筛选条件是索引列前导列的一个范围，同样意味着无法直接通过索引查找查询到符合条件的数据

Using where
* 查询的列未被索引覆盖，where筛选条件非索引的前导列，Extra中为Using where

Using index condition
* 查询的列不全在索引中，where条件中是一个前导列的范围
* 查询列不完全被索引覆盖，查询条件完全可以使用到索引（进行索引查找）
